---
title: "Task_4_analysis"
author: "Gleb V"
date: "22/07/2020"
output: 
  html_document:
    toc: true
    toc_float: true
---
# Task 4.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
library(here)
all_candy_data <- read_csv(here::here("clean_data/candy_data_combined.csv"), 
                           guess_max = 9349)
view(all_candy_data)
```

## Answer 1.

* To calculate how many total rating were submitted I took total number of columns, subtracted 5, as the first 5 columns of the dataset do not contain ratings. I multiplied the result of subtraction by number of rows in the dataset. 
```{r}
num_col <- ncol(all_candy_data)-5
num_row <- nrow(all_candy_data)+0 # result is stored as an Integer without performing an arithmetic operation
total_ratings = num_col * num_row
```
There were total of `r as.integer(total_ratings)` submitted over 3 years.

## Answer 2. 
* Average age of people going out/not going out trick or treating was:
```{r}
average_age <- all_candy_data %>%
  select(age, trick_or_treating) %>%
  drop_na() %>% #I dropped NA values without imputing, as the dataset is large enough to be representative of the general population. 
  group_by(trick_or_treating) %>%
  summarise(unique(trick_or_treating), average_age = ceiling(mean(age))) %>%
  mutate(going_out = trick_or_treating, average_age) %>%
  select(going_out, average_age)
average_age

```
Average age of people going out trick or treating was 34. Average age of those not going out was 39.

## Answer 3. 

* The following candies received the most "joy", "meh" and "despair" ratings.
```{r}
#count total of each rating for each candy
ratings_count <- all_candy_data %>% 
  pivot_longer(cols = "butterfinger":"sandwich_sized_bags_filled_with_booberry_crunch",
               names_to = "candy_name", 
               values_to = "candy_rating") %>%
  mutate(candy_rating = ifelse(is.na(candy_rating), "UNRATED", candy_rating)) %>% # replace NA ratings with chr "UNRATED"
  group_by(candy_name, candy_rating) %>%
  summarise(number_of_ratings_received = n())

#find candy rated top for "JOY"
top_joy <- ratings_count %>%
  filter(candy_rating == "JOY") %>% 
  arrange(desc(number_of_ratings_received)) %>%
  head(1)

#find candy rated top for "MEH"
top_meh <- ratings_count %>%
  filter(candy_rating == "MEH") %>% 
  arrange(desc(number_of_ratings_received)) %>%
  head(1)

#find candy rated top for "DESPAIR"
top_despair <- ratings_count %>%
  filter(candy_rating == "DESPAIR") %>% 
  arrange(desc(number_of_ratings_received)) %>%
  head(1)

#find top UNRATED candy
top_unrated <- ratings_count %>%
  filter(candy_rating == "UNRATED") %>% 
  arrange(desc(number_of_ratings_received)) %>%
  head(1)

#show all top candies in a single dataframe
top_ratings <- bind_rows(top_joy, top_meh, top_despair, top_unrated)

top_ratings
```
According to the survey, respondents were the most exited about getting a "proper size" candy, regardless of its brand or flavour. 

Personally, I agree with the general sentiment of the survey - lollipos are... well... "meh".

Having analysed this dataset, I went to read about trick or treating in general. Turns out it is a thing to get glow sticks for halloween, the problem arises when they break. Click [here](https://chicago.cbslocal.com/2013/10/30/glow-sticks-top-worry-for-parents-calling-poison-control-on-halloween/) to read more.

It looks like quite a lot of respondents are trying to overcome their M&M's addiction by abstaining from them. The struggle is so real, that they couldn't even provide rating.

## Answer 4. 
```{r}
#number of "DESPAIR" ratings for starburst.

starburst_despair <- ratings_count %>%
  filter(candy_name == "starburst", candy_rating == "DESPAIR") %>% 
  arrange(desc(number_of_ratings_received))
starburst_despair
```
A total of `r starburst_despair$number_of_ratings_received` people rated Starburst as "DESPAIR"

</br>
</br>

#### Count despair as -1, joy as +1 and meh as 0.
* I created a new dataframe called `numeric_ratings` before performing analysis for Q6, Q7 & Q8.
```{r}
numeric_ratings <- all_candy_data %>%
  pivot_longer(cols = "butterfinger":"sandwich_sized_bags_filled_with_booberry_crunch",
               names_to = "candy_name", 
               values_to = "candy_rating") %>%
  mutate(candy_rating = ifelse(is.na(candy_rating), "UNRATED", candy_rating)) %>%
  mutate(numeric_rating = case_when(
    candy_rating == "DESPAIR" ~ -1,
    candy_rating == "JOY" ~ +1,
    candy_rating == "MEH" ~ 0, 
    TRUE ~ 0
    ))
```
I treated all NA values as "UNRATED" and counted them as 0, therefore they do not affect the overall rating. 

## Answer 6.

The most popular candy using the above rating system for each gender. 

* To answer this question I treat numeric score as indication of popularity.
```{r}
#find the most popular candy by gender "Female" 
most_pop_by_gender_f <- numeric_ratings %>%
  filter(gender == "Female") %>%
  group_by(candy_name) %>%
  summarise(numeric_rating = sum(numeric_rating)) %>%
  mutate(gender = "Female", candy_name, numeric_rating) %>%
  arrange(desc(numeric_rating)) %>%
  head(1)

#find most popular candy by gender "Male"
most_pop_by_gender_m <- numeric_ratings %>%
  filter(gender == "Male") %>%
  group_by(candy_name) %>%
  summarise(numeric_rating = sum(numeric_rating)) %>%
  mutate(gender = "Male", candy_name, numeric_rating) %>%
  arrange(desc(numeric_rating)) %>%
  head(1)

#find most popular candy by NA gender = "Undisclosed"
most_pop_by_gender_u <- numeric_ratings %>%
  mutate(gender = ifelse(gender != "Female" & 
                         gender != "Male" |
                         is.na(gender), "Undisclosed", gender)) %>%
  filter(gender == "Undisclosed") %>%
  group_by(candy_name) %>%
  summarise(numeric_rating = sum(numeric_rating)) %>%
  mutate(gender = "Undisclosed", candy_name, numeric_rating) %>%
  arrange(desc(numeric_rating)) %>%
  head(1)

#combine all three in a single dataframe for easier readability.
most_pop_by_gender <- bind_rows(most_pop_by_gender_f, 
                                most_pop_by_gender_m, 
                                most_pop_by_gender_u) %>%
  select(gender, candy_name, numeric_rating)

most_pop_by_gender

```
As before, Full Sized Candy Bars are the most popular amongst everyone and this preference does not seem to depend on the gender.

## Answer 7. 

The most popular candy on numeric rating scale each year. 
* To answer this question I am using the dataframe `numeric_ratings` I created previously, as it is already in long format, which is more convenient for analysis than wide format.
```{r}
#find the most popular candy in 2015
most_pop_2015 <- numeric_ratings %>%
  select(year, candy_name, numeric_rating) %>%
  filter(year == "2015") %>%
  group_by(candy_name) %>%
  summarise(numeric_rating = sum(numeric_rating)) %>%
  mutate(year = "2015", candy_name, numeric_rating) %>%
  arrange(desc(numeric_rating)) %>%
  head(1)
most_pop_2015

#find the most polular candy in 2016
most_pop_2016 <- numeric_ratings %>%
  select(year, candy_name, numeric_rating) %>%
  filter(year == "2016") %>%
  group_by(candy_name) %>%
  summarise(numeric_rating = sum(numeric_rating)) %>%
  mutate(year = "2016", candy_name, numeric_rating) %>%
  arrange(desc(numeric_rating)) %>%
  head(1)
most_pop_2016

#find the most polular candy in 2017
most_pop_2017 <- numeric_ratings %>%
  select(year, candy_name, numeric_rating) %>%
  filter(year == "2017") %>%
  group_by(candy_name) %>%
  summarise(numeric_rating = sum(numeric_rating)) %>%
  mutate(year = "2017", candy_name, numeric_rating) %>%
  arrange(desc(numeric_rating)) %>%
  head(1)
most_pop_2017

#combine all three dataframes in a single dataframe for easier readability.
most_pop_by_year <- bind_rows(most_pop_2015, 
                              most_pop_2016, 
                              most_pop_2017) %>%
  select(year, candy_name, numeric_rating)
most_pop_by_year
```


